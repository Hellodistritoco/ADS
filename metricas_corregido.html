<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Métricas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: white; }
    .form-control, .form-select { background-color: #1e1e1e; color: white; border: 1px solid #444; }
    .form-label { color: #bbb; }
    .readonly-field { background-color: #2a2a2a !important; color: #ccc; }
    .card {
      background-color: #1e1e1e;
      border: 1px solid #444;
    }
    .strategy-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    table { color: white; }
    thead { color: #0dcaf0; background-color: #1e1e1e; }
    .table-dark { background-color: #1e1e1e; }
    .table-dark td, .table-dark th { border-color: #444; }
    .csv-preview {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 5px;
    }
    .upload-area {
      border: 2px dashed #444;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .upload-area:hover {
      border-color: #0d6efd;
      background-color: rgba(13, 110, 253, 0.1);
    }
    .upload-area.dragover {
      border-color: #28a745;
      background-color: rgba(40, 167, 69, 0.1);
    }
    
    /* Nuevos estilos para etapas y métricas */
    .etapa-card {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      border: none;
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      transition: transform 0.2s;
    }
    .etapa-card:hover {
      transform: translateY(-3px);
    }
    .etapa-selector {
      cursor: pointer;
      border: 2px solid #444;
      border-radius: 10px;
      padding: 15px;
      margin: 10px;
      transition: all 0.3s;
      text-align: center;
    }
    .etapa-selector:hover {
      border-color: #0d6efd;
      background-color: rgba(13, 110, 253, 0.1);
    }
    .etapa-selector.selected {
      border-color: #28a745;
      background-color: rgba(40, 167, 69, 0.2);
    }
    .metrica-tag {
      display: inline-block;
      background-color: #6c757d;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      margin: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .metrica-tag:hover {
      background-color: #0d6efd;
    }
    .metrica-tag.selected {
      background-color: #28a745;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    .step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      position: relative;
    }
    .step.active {
      background-color: #0d6efd;
    }
    .step.completed {
      background-color: #28a745;
    }
    .step::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 30px;
      height: 2px;
      background-color: #444;
      transform: translateY(-50%);
    }
    .step:last-child::after {
      display: none;
    }
    .step.completed::after {
      background-color: #28a745;
    }
    
    /* Estilos para el popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .popup-content {
      background: #1e1e1e;
      border: 2px solid #28a745;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      max-width: 450px;
      animation: popupSlide 0.3s ease-in-out;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    @keyframes popupSlide {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .popup-icon {
      font-size: 4rem;
      color: #28a745;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .popup-title {
      color: #28a745;
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .file-info {
      background-color: #2a2a2a;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="mdi mdi-chart-bar"></i> Métricas de Campañas</h2>
      <div>
        <a href="ver_estrategias.html" class="btn btn-secondary me-2">
          <i class="mdi mdi-lightbulb-multiple-outline"></i> Ver Estrategias
        </a>
        <a href="index.html" class="btn btn-secondary">
          <i class="mdi mdi-home"></i> Dashboard
        </a>
      </div>
    </div>

    <!-- Indicador de pasos -->
    <div class="step-indicator mb-4">
      <div class="step active" id="step1">1</div>
      <div class="step" id="step2">2</div>
      <div class="step" id="step3">3</div>
      <div class="step" id="step4">4</div>
      <div class="step" id="step5">5</div>
    </div>

    <!-- Paso 1: Selectores de Cliente y Estrategia -->
    <div id="paso1" class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="mdi mdi-account-group"></i> Paso 1: Seleccionar Cliente y Estrategia
        </h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Cliente</label>
            <select id="clienteSelect" class="form-select" onchange="cargarEstrategiasCliente()" required>
              <option value="">Selecciona un cliente</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Estrategia</label>
            <select id="estrategiaSelect" class="form-select" onchange="cargarDatosEstrategia()" required>
              <option value="">Primero selecciona un cliente</option>
            </select>
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" onclick="siguientePaso(2)" id="btnPaso1" disabled>
            Siguiente <i class="mdi mdi-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Información de la Estrategia Seleccionada -->
    <div id="infoEstrategia" class="strategy-info" style="display: none;">
      <h5 class="text-white mb-3">
        <i class="mdi mdi-lightbulb-on"></i> 
        Información de la Estrategia
      </h5>
      <div class="row text-white">
        <div class="col-md-6">
          <p class="mb-1"><strong>Cliente:</strong> <span id="nombreCliente"></span></p>
          <p class="mb-1"><strong>Estrategia:</strong> <span id="nombreEstrategia"></span></p>
          <p class="mb-0"><strong>Tipo:</strong> <span id="tipoEstrategia"></span></p>
        </div>
        <div class="col-md-6">
          <p class="mb-1"><strong>Plataforma:</strong> <span id="plataformaEstrategia"></span></p>
          <p class="mb-1"><strong>Presupuesto:</strong> <span id="presupuestoEstrategia"></span></p>
          <p class="mb-0"><strong>KPIs:</strong> <span id="kpisEstrategia"></span></p>
        </div>
      </div>
    </div>

    <!-- Paso 2: Selección de Etapa del Funnel -->
    <div id="paso2" class="card mb-4" style="display: none;">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="mdi mdi-target"></i> Paso 2: Selecciona la Etapa del Funnel
        </h5>
        <div class="row">
          <div class="col-md-4">
            <div class="etapa-selector" onclick="seleccionarEtapa('TOFU')" id="etapa-TOFU">
              <h6><i class="mdi mdi-bullhorn"></i> TOFU</h6>
              <p class="mb-0"><strong>Top of Funnel</strong></p>
              <small>Awareness / Interacción</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="etapa-selector" onclick="seleccionarEtapa('MOFU')" id="etapa-MOFU">
              <h6><i class="mdi mdi-account-search"></i> MOFU</h6>
              <p class="mb-0"><strong>Middle of Funnel</strong></p>
              <small>Leads / Consideración</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="etapa-selector" onclick="seleccionarEtapa('BOFU')" id="etapa-BOFU">
              <h6><i class="mdi mdi-cart"></i> BOFU</h6>
              <p class="mb-0"><strong>Bottom of Funnel</strong></p>
              <small>Conversiones / ROAS</small>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <button class="btn btn-secondary" onclick="anteriorPaso(1)">
            <i class="mdi mdi-arrow-left"></i> Anterior
          </button>
          <button class="btn btn-primary" onclick="siguientePaso(3)" id="btnPaso2" disabled>
            Siguiente <i class="mdi mdi-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Paso 3: Selección de Tipo de Métrica -->
    <div id="paso3" class="card mb-4" style="display: none;">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="mdi mdi-chart-line"></i> Paso 3: Selecciona el Tipo de Métrica
        </h5>
        <div class="row">
          <div class="col-12">
            <div class="text-center mb-3">
              <div class="metrica-tag" onclick="seleccionarMetrica('Ecommerce')">
                <i class="mdi mdi-shopping"></i> Ecommerce
              </div>
              <div class="metrica-tag" onclick="seleccionarMetrica('Prospecting')">
                <i class="mdi mdi-account-search"></i> Prospecting
              </div>
              <div class="metrica-tag" onclick="seleccionarMetrica('Leads')">
                <i class="mdi mdi-account-plus"></i> Leads
              </div>
              <div class="metrica-tag" onclick="seleccionarMetrica('Remarketing')">
                <i class="mdi mdi-refresh"></i> Remarketing
              </div>
            </div>
            <div class="text-center mb-3">
              <div class="metrica-tag" onclick="seleccionarMetrica('Interaccion')">
                <i class="mdi mdi-heart"></i> Interacción
              </div>
              <div class="metrica-tag" onclick="seleccionarMetrica('Visitas al Perfil')">
                <i class="mdi mdi-account-circle"></i> Visitas al Perfil
              </div>
              <div class="metrica-tag" onclick="seleccionarMetrica('Mensajes a Whatsapp')">
                <i class="mdi mdi-whatsapp"></i> Mensajes a WhatsApp
              </div>
              <div class="metrica-tag" onclick="seleccionarMetrica('Formularios de contacto')">
                <i class="mdi mdi-form-select"></i> Formularios de contacto
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <button class="btn btn-secondary" onclick="anteriorPaso(2)">
            <i class="mdi mdi-arrow-left"></i> Anterior
          </button>
          <button class="btn btn-primary" onclick="siguientePaso(4)" id="btnPaso3" disabled>
            Siguiente <i class="mdi mdi-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Paso 4: Configuración del Período -->
    <div id="paso4" class="card mb-4" style="display: none;">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="mdi mdi-calendar-range"></i> Paso 4: Configuración del Período
        </h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Período de las Métricas</label>
            <div class="row g-2">
              <div class="col-6">
                <input type="date" class="form-control" id="fechaInicio" required>
                <small class="text-muted">Fecha inicio</small>
              </div>
              <div class="col-6">
                <input type="date" class="form-control" id="fechaFin" required>
                <small class="text-muted">Fecha fin</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Descripción de las Métricas</label>
            <textarea class="form-control" id="descripcionMetricas" rows="3" placeholder="Describe el contenido de estas métricas..."></textarea>
          </div>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <button class="btn btn-secondary" onclick="anteriorPaso(3)">
            <i class="mdi mdi-arrow-left"></i> Anterior
          </button>
          <button class="btn btn-primary" onclick="siguientePaso(5)" id="btnPaso4" disabled>
            Siguiente <i class="mdi mdi-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Paso 5: Subida del CSV -->
    <div id="paso5" style="display: none;">
      <form id="csvForm" enctype="multipart/form-data" class="mb-4">
        <!-- Campos ocultos -->
        <input type="hidden" id="cliente_id" name="cliente_id">
        <input type="hidden" id="estrategia_id" name="estrategia_id">
        <input type="hidden" id="cliente_nombre" name="cliente_nombre">
        <input type="hidden" id="estrategia_nombre" name="estrategia_nombre">
        <input type="hidden" id="tipo_estrategia" name="tipo_estrategia">
        <input type="hidden" id="plataforma" name="plataforma">
        <input type="hidden" id="etapa_funnel" name="etapa_funnel">
        <input type="hidden" id="tipo_metrica" name="tipo_metrica">
        <input type="hidden" id="fecha_inicio" name="fecha_inicio">
        <input type="hidden" id="fecha_fin" name="fecha_fin">
        <input type="hidden" id="descripcion" name="descripcion">

        <div class="card">
          <div class="card-body">
            <h5 class="card-title mb-3">
              <i class="mdi mdi-upload"></i> Paso 5: Subir Archivo CSV
            </h5>
            
            <!-- Resumen de la configuración -->
            <div class="alert alert-info mb-4">
              <h6><i class="mdi mdi-information"></i> Resumen de Configuración:</h6>
              <div class="row">
                <div class="col-md-6">
                  <strong>Cliente:</strong> <span id="resumenCliente"></span><br>
                  <strong>Estrategia:</strong> <span id="resumenEstrategia"></span><br>
                  <strong>Etapa:</strong> <span id="resumenEtapa"></span>
                </div>
                <div class="col-md-6">
                  <strong>Tipo de Métrica:</strong> <span id="resumenMetrica"></span><br>
                  <strong>Período:</strong> <span id="resumenPeriodo"></span>
                </div>
              </div>
            </div>
            
            <!-- Área de subida de archivo -->
            <div id="uploadArea" class="upload-area" onclick="document.getElementById('csvFile').click()">
              <div id="uploadContent">
                <i class="mdi mdi-cloud-upload" style="font-size: 3rem; color: #0d6efd;"></i>
                <h5 class="mt-2">Haz clic para seleccionar archivo CSV</h5>
                <p class="text-muted">O arrastra y suelta tu archivo aquí</p>
                <small class="text-muted">Formatos soportados: .csv</small>
              </div>
              <input type="file" id="csvFile" name="csv_file" accept=".csv" style="display: none;" onchange="procesarCSV()">
            </div>

            <!-- Información del archivo -->
            <div id="fileInfo" style="display: none;" class="file-info">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <i class="mdi mdi-file-table text-success"></i>
                  <strong id="fileName"></strong>
                  <span id="fileSize" class="text-muted"></span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarArchivo()">
                  <i class="mdi mdi-close"></i>
                </button>
              </div>
              <div class="mt-2">
                <small><strong>Filas:</strong> <span id="fileRows"></span> | <strong>Columnas:</strong> <span id="fileCols"></span></small>
              </div>
            </div>

            <!-- Botones de navegación y envío -->
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" onclick="anteriorPaso(4)">
                <i class="mdi mdi-arrow-left"></i> Anterior
              </button>
              <button type="submit" class="btn btn-success btn-lg" id="btnSubir" style="display: none;">
                <i class="mdi mdi-upload"></i> Guardar Métricas
              </button>
            </div>
          </div>
        </div>
      </form>

      <!-- Vista previa del CSV -->
      <div id="csvPreview" style="display: none;" class="card">
        <div class="card-body">
          <h5 class="card-title">Vista Previa del CSV</h5>
          <div class="csv-preview">
            <div class="table-responsive">
              <table id="previewTable" class="table table-dark table-striped table-bordered table-sm">
                <thead id="previewHeader"></thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
          </div>
          <small class="text-muted">Mostrando las primeras 10 filas</small>
        </div>
      </div>
    </div>

    <!-- Mensaje inicial -->
    <div id="mensajeInicial" class="text-center py-5">
      <i class="mdi mdi-chart-bar" style="font-size: 4rem; color: #666;"></i>
      <h4 class="mt-3">Proceso de Carga de Métricas</h4>
      <p class="text-muted">Sigue los pasos para configurar y subir tus métricas de campaña</p>
    </div>
  </div>

  <!-- Popup de éxito -->
  <div id="popupOverlay" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-icon">
        <i class="mdi mdi-check-circle"></i>
      </div>
      <div class="popup-title">¡MÉTRICAS EXITOSAS!</div>
      <p class="text-light mb-3">
        Las métricas han sido procesadas y guardadas correctamente en la base de datos.
      </p>
      <div class="alert alert-success bg-success bg-opacity-25 border-success text-light mb-3">
        <i class="mdi mdi-check-circle"></i>
        <strong>Archivo procesado:</strong> <span id="archivoInfo">Archivo cargado</span><br>
        <strong>Cliente:</strong> <span id="clienteInfo">Cliente cargado</span><br>
        <strong>Estrategia:</strong> <span id="estrategiaInfo">Estrategia cargada</span><br>
        <strong>Etapa:</strong> <span id="etapaInfo">No especificado</span><br>
        <strong>Tipo:</strong> <span id="tipoInfo">No especificado</span>
      </div>
      <div class="popup-buttons mt-3">
        <button type="button" class="btn btn-primary btn-lg me-2" onclick="irAVerMetricas()">
          <i class="mdi mdi-chart-line"></i> IR A VER LAS MÉTRICAS
        </button>
        <button type="button" class="btn btn-success me-2" onclick="nuevasMetricas()">
          <i class="mdi mdi-plus"></i> NUEVAS MÉTRICAS
        </button>
        <button type="button" class="btn btn-secondary" onclick="cerrarPopup()">
          <i class="mdi mdi-close"></i> CERRAR
        </button>
      </div>
    </div>
  </div>

  <script>
    // DATOS SIMULADOS PARA DEMOSTRACIÓN
    const clientesSimulados = [
      { id: 1, nombre_cliente: "Empresa ABC" },
      { id: 2, nombre_cliente: "Corporación XYZ" },
      { id: 3, nombre_cliente: "StartUp 123" },
      { id: 4, nombre_cliente: "Negocio Digital" }
    ];

    const estrategiasSimuladas = {
      1: [
        {
          id: 101,
          cliente_id: 1,
          nombre_cliente: "Empresa ABC",
          nombre_estrategia: "Campaña Black Friday",
          tipo_estrategia: "Ecommerce",
          plataformas: "Facebook, Instagram",
          presupuesto_estrategia: "50000",
          kpis: "ROAS, CTR, Conversiones"
        },
        {
          id: 102,
          cliente_id: 1,
          nombre_cliente: "Empresa ABC",
          nombre_estrategia: "Prospecting Q1",
          tipo_estrategia: "Lead Generation",
          plataformas: "LinkedIn, Google Ads",
          presupuesto_estrategia: "30000",
          kpis: "CPL, CTR, Leads Calificados"
        }
      ],
      2: [
        {
          id: 201,
          cliente_id: 2,
          nombre_cliente: "Corporación XYZ",
          nombre_estrategia: "Brand Awareness",
          tipo_estrategia: "Branding",
          plataformas: "Facebook, Instagram, TikTok",
          presupuesto_estrategia: "75000",
          kpis: "Reach, Engagement, Brand Recall"
        }
      ],
      3: [
        {
          id: 301,
          cliente_id: 3,
          nombre_cliente: "StartUp 123",
          nombre_estrategia: "Lanzamiento Producto",
          tipo_estrategia: "Performance",
          plataformas: "Google Ads, Facebook",
          presupuesto_estrategia: "25000",
          kpis: "CPA, ROAS, Conversiones"
        }
      ],
      4: [
        {
          id: 401,
          cliente_id: 4,
          nombre_cliente: "Negocio Digital",
          nombre_estrategia: "Remarketing Campaign",
          tipo_estrategia: "Remarketing",
          plataformas: "Google Ads, Facebook, Instagram",
          presupuesto_estrategia: "40000",
          kpis: "ROAS, CTR, Frequency"
        }
      ]
    };

    let todosLosClientes = [];
    let todasLasEstrategias = [];
    let csvData = null;
    let estrategiaSeleccionada = null;
    let etapaSeleccionada = '';
    let metricaSeleccionada = '';
    let pasoActual = 1;

    // Cargar datos al inicializar
    document.addEventListener('DOMContentLoaded', function() {
      cargarClientes();
      
      // Verificar parámetros de URL
      const urlParams = new URLSearchParams(window.location.search);
      const clienteId = urlParams.get('cliente_id');
      const estrategiaId = urlParams.get('estrategia_id');
      const etapa = urlParams.get('etapa');
      const tipo = urlParams.get('tipo');
      const archivo = urlParams.get('archivo');
      
      // Verificar éxito y mostrar popup
      if (urlParams.get('exito') === '1') {
        // Llenar información del popup con los parámetros de URL
        if (archivo) {
          document.getElementById('archivoInfo').textContent = decodeURIComponent(archivo);
        }
        
        // Cargar información del cliente y estrategia si están disponibles
        if (clienteId && estrategiaId) {
          document.getElementById('cliente_id').value = clienteId;
          document.getElementById('estrategia_id').value = estrategiaId;
          
          // Cargar datos para mostrar en el popup
          setTimeout(() => {
            cargarDatosParaPopup(clienteId, estrategiaId, etapa, tipo);
          }, 500);
        }
        
        // Mostrar popup inmediatamente
        mostrarPopup();
        
        // Limpiar la URL sin recargar la página
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Preseleccionar si vienen parámetros (para casos normales, no de éxito)
      if (clienteId && !urlParams.get('exito')) {
        setTimeout(() => {
          document.getElementById('clienteSelect').value = clienteId;
          cargarEstrategiasCliente();
          
          if (estrategiaId) {
            setTimeout(() => {
              document.getElementById('estrategiaSelect').value = estrategiaId;
              cargarDatosEstrategia();
            }, 500);
          }
        }, 500);
      }

      // Configurar event listeners para fechas
      document.getElementById('fechaInicio').addEventListener('change', validarFechas);
      document.getElementById('fechaFin').addEventListener('change', validarFechas);
      document.getElementById('descripcionMetricas').addEventListener('input', validarFechas);

      // Configurar drag & drop
      setupDragAndDrop();
    });

    // Cargar lista de clientes (simulados)
    function cargarClientes() {
      try {
        // Simular datos de clientes
        todosLosClientes = clientesSimulados;
        const select = document.getElementById('clienteSelect');
        
        clientesSimulados.forEach(cliente => {
          const option = document.createElement('option');
          option.value = cliente.id;
          option.textContent = cliente.nombre_cliente;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error al cargar clientes:', error);
      }
    }

    // Cargar estrategias del cliente seleccionado
    function cargarEstrategiasCliente() {
      const clienteId = document.getElementById('clienteSelect').value;
      const estrategiaSelect = document.getElementById('estrategiaSelect');
      
      // Limpiar estrategias
      estrategiaSelect.innerHTML = '<option value="">Selecciona una estrategia</option>';
      document.getElementById('infoEstrategia').style.display = 'none';
      document.getElementById('btnPaso1').disabled = true;
      
      if (!clienteId) {
        estrategiaSelect.innerHTML = '<option value="">Primero selecciona un cliente</option>';
        return;
      }

      try {
        // Simular carga de estrategias
        const estrategias = estrategiasSimuladas[clienteId] || [];
        todasLasEstrategias = estrategias;
        
        if (estrategias.length === 0) {
          estrategiaSelect.innerHTML = '<option value="">No hay estrategias para este cliente</option>';
          return;
        }
        
        estrategias.forEach(estrategia => {
          const option = document.createElement('option');
          option.value = estrategia.id;
          option.textContent = `${estrategia.nombre_estrategia} (${estrategia.tipo_estrategia})`;
          estrategiaSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error al cargar estrategias:', error);
      }
    }

    // Cargar datos de la estrategia seleccionada
    function cargarDatosEstrategia() {
      const estrategiaId = document.getElementById('estrategiaSelect').value;
      
      if (!estrategiaId) {
        document.getElementById('infoEstrategia').style.display = 'none';
        document.getElementById('btnPaso1').disabled = true;
        return;
      }

      // Buscar la estrategia en el array
      estrategiaSeleccionada = todasLasEstrategias.find(e => e.id == estrategiaId);
      
      if (estrategiaSeleccionada) {
        // Mostrar información de la estrategia
        document.getElementById('nombreCliente').textContent = estrategiaSeleccionada.nombre_cliente;
        document.getElementById('nombreEstrategia').textContent = estrategiaSeleccionada.nombre_estrategia;
        document.getElementById('tipoEstrategia').textContent = estrategiaSeleccionada.tipo_estrategia;
        document.getElementById('plataformaEstrategia').textContent = estrategiaSeleccionada.plataformas;
        document.getElementById('presupuestoEstrategia').textContent = ' + parseFloat(estrategiaSeleccionada.presupuesto_estrategia).toLocaleString();
        document.getElementById('kpisEstrategia').textContent = estrategiaSeleccionada.kpis;
        
        // Llenar campos ocultos del formulario
        document.getElementById('cliente_id').value = estrategiaSeleccionada.cliente_id;
        document.getElementById('estrategia_id').value = estrategiaSeleccionada.id;
        document.getElementById('cliente_nombre').value = estrategiaSeleccionada.nombre_cliente;
        document.getElementById('estrategia_nombre').value = estrategiaSeleccionada.nombre_estrategia;
        document.getElementById('tipo_estrategia').value = estrategiaSeleccionada.tipo_estrategia;
        document.getElementById('plataforma').value = estrategiaSeleccionada.plataformas;
        
        // Mostrar información y habilitar siguiente paso
        document.getElementById('infoEstrategia').style.display = 'block';
        document.getElementById('btnPaso1').disabled = false;
        document.getElementById('mensajeInicial').style.display = 'none';
      }
    }

    // Funciones de navegación entre pasos
    function siguientePaso(paso) {
      // Ocultar paso actual
      document.getElementById(`paso${pasoActual}`).style.display = 'none';
      
      // Marcar paso actual como completado
      document.getElementById(`step${pasoActual}`).classList.remove('active');
      document.getElementById(`step${pasoActual}`).classList.add('completed');
      
      // Mostrar nuevo paso
      document.getElementById(`paso${paso}`).style.display = 'block';
      document.getElementById(`step${paso}`).classList.add('active');
      
      // Actualizar paso actual
      pasoActual = paso;
      
      // Acciones específicas por paso
      if (paso === 5) {
        actualizarResumen();
      }
    }

    function anteriorPaso(paso) {
      // Ocultar paso actual
      document.getElementById(`paso${pasoActual}`).style.display = 'none';
      document.getElementById(`step${pasoActual}`).classList.remove('active');
      
      // Mostrar paso anterior
      document.getElementById(`paso${paso}`).style.display = 'block';
      document.getElementById(`step${paso}`).classList.remove('completed');
      document.getElementById(`step${paso}`).classList.add('active');
      
      // Actualizar paso actual
      pasoActual = paso;
    }

    // Seleccionar etapa del funnel
    function seleccionarEtapa(etapa) {
      // Limpiar selección anterior
      document.querySelectorAll('.etapa-selector').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Seleccionar nueva etapa
      document.getElementById(`etapa-${etapa}`).classList.add('selected');
      etapaSeleccionada = etapa;
      document.getElementById('etapa_funnel').value = etapa;
      
      // Habilitar siguiente paso
      document.getElementById('btnPaso2').disabled = false;
    }

    // Seleccionar tipo de métrica
    function seleccionarMetrica(metrica) {
      // Limpiar selección anterior
      document.querySelectorAll('.metrica-tag').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Seleccionar nueva métrica
      event.target.classList.add('selected');
      metricaSeleccionada = metrica;
      document.getElementById('tipo_metrica').value = metrica;
      
      // Habilitar siguiente paso
      document.getElementById('btnPaso3').disabled = false;
    }

    // Validar fechas y habilitar siguiente paso
    function validarFechas() {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      
      if (fechaInicio && fechaFin) {
        document.getElementById('fecha_inicio').value = fechaInicio;
        document.getElementById('fecha_fin').value = fechaFin;
        document.getElementById('descripcion').value = document.getElementById('descripcionMetricas').value;
        document.getElementById('btnPaso4').disabled = false;
      } else {
        document.getElementById('btnPaso4').disabled = true;
      }
    }

    // Actualizar resumen antes de subir archivo
    function actualizarResumen() {
      document.getElementById('resumenCliente').textContent = estrategiaSeleccionada.nombre_cliente;
      document.getElementById('resumenEstrategia').textContent = estrategiaSeleccionada.nombre_estrategia;
      document.getElementById('resumenEtapa').textContent = etapaSeleccionada;
      document.getElementById('resumenMetrica').textContent = metricaSeleccionada;
      
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      document.getElementById('resumenPeriodo').textContent = `${fechaInicio} - ${fechaFin}`;
    }

    // Configurar drag and drop
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('uploadArea');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight(e) {
        uploadArea.classList.add('dragover');
      }
      
      function unhighlight(e) {
        uploadArea.classList.remove('dragover');
      }
      
      uploadArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          document.getElementById('csvFile').files = files;
          procesarCSV();
        }
      }
    }

    // Procesar archivo CSV
    function procesarCSV() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Por favor selecciona un archivo CSV válido');
        return;
      }
      
      // Mostrar información del archivo
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
      document.getElementById('fileInfo').style.display = 'block';
      
      // Leer el archivo
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvText = e.target.result;
        parsearCSV(csvText);
      };
      reader.readAsText(file);
    }

    // Parsear CSV y mostrar vista previa
    function parsearCSV(csvText) {
      // Dividir en líneas y procesar
      const lines = csvText.split('\n').filter(line => line.trim());
      
      if (lines.length < 2) {
        alert('El archivo CSV debe tener al menos una fila de encabezados y una fila de datos');
        return;
      }
      
      // Procesar encabezados
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      
      // Procesar datos
      const rows = [];
      for (let i = 1; i < Math.min(lines.length, 11); i++) { // Máximo 10 filas de preview
        const row = lines[i].split(',').map(cell => cell.trim().replace(/"/g, ''));
        rows.push(row);
      }
      
      csvData = {
        headers: headers,
        totalRows: lines.length - 1,
        previewRows: rows
      };
      
      // Actualizar información del archivo
      document.getElementById('fileRows').textContent = csvData.totalRows;
      document.getElementById('fileCols').textContent = headers.length;
      
      // Mostrar vista previa
      mostrarVistaPrevia();
      
      // Mostrar botón de envío
      document.getElementById('btnSubir').style.display = 'block';
    }

    // Mostrar vista previa de la tabla
    function mostrarVistaPrevia() {
      if (!csvData) return;
      
      const headerRow = document.getElementById('previewHeader');
      const bodyRows = document.getElementById('previewBody');
      
      // Limpiar tabla
      headerRow.innerHTML = '';
      bodyRows.innerHTML = '';
      
      // Crear encabezados
      const headerTr = document.createElement('tr');
      csvData.headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerTr.appendChild(th);
      });
      headerRow.appendChild(headerTr);
      
      // Crear filas de datos
      csvData.previewRows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        bodyRows.appendChild(tr);
      });
      
      document.getElementById('csvPreview').style.display = 'block';
    }

    // Eliminar archivo seleccionado
    function eliminarArchivo() {
      document.getElementById('csvFile').value = '';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('csvPreview').style.display = 'none';
      document.getElementById('btnSubir').style.display = 'none';
      csvData = null;
    }

    // Manejar envío del formulario
    document.getElementById('csvForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!csvData) {
        alert('Por favor selecciona un archivo CSV');
        return;
      }
      
      // Simular éxito del envío
      setTimeout(() => {
        mostrarPopup();
      }, 1000);
    });

    // Nueva función para cargar datos para el popup
    function cargarDatosParaPopup(clienteId, estrategiaId, etapa, tipo) {
      try {
        // Buscar cliente
        const cliente = clientesSimulados.find(c => c.id == clienteId);
        if (cliente) {
          document.getElementById('clienteInfo').textContent = cliente.nombre_cliente;
        }
        
        // Buscar estrategia
        const estrategiasCliente = estrategiasSimuladas[clienteId] || [];
        const estrategia = estrategiasCliente.find(e => e.id == estrategiaId);
        if (estrategia) {
          document.getElementById('estrategiaInfo').textContent = estrategia.nombre_estrategia;
        }
        
        // Llenar otros campos
        if (etapa) {
          document.getElementById('etapaInfo').textContent = decodeURIComponent(etapa);
        }
        if (tipo) {
          document.getElementById('tipoInfo').textContent = decodeURIComponent(tipo);
        }
      } catch (error) {
        console.error('Error al cargar datos para popup:', error);
        // Valores por defecto si hay error
        document.getElementById('clienteInfo').textContent = 'Cliente cargado';
        document.getElementById('estrategiaInfo').textContent = 'Estrategia cargada';
        document.getElementById('etapaInfo').textContent = etapa || 'No especificado';
        document.getElementById('tipoInfo').textContent = tipo || 'No especificado';
      }
    }

    // Funciones del popup
    function mostrarPopup() {
      // Llenar información del popup
      const archivo = document.getElementById('csvFile').files[0];
      if (archivo) {
        document.getElementById('archivoInfo').textContent = archivo.name;
      }
      
      document.getElementById('clienteInfo').textContent = estrategiaSeleccionada?.nombre_cliente || 'No especificado';
      document.getElementById('estrategiaInfo').textContent = estrategiaSeleccionada?.nombre_estrategia || 'No especificado';
      document.getElementById('etapaInfo').textContent = etapaSeleccionada || 'No especificado';
      document.getElementById('tipoInfo').textContent = metricaSeleccionada || 'No especificado';
      
      document.getElementById('popupOverlay').style.display = 'flex';
    }

    function cerrarPopup() {
      document.getElementById('popupOverlay').style.display = 'none';
    }

    function nuevasMetricas() {
      // Reiniciar todo el proceso
      pasoActual = 1;
      etapaSeleccionada = '';
      metricaSeleccionada = '';
      csvData = null;
      estrategiaSeleccionada = null;
      
      // Limpiar formularios
      document.getElementById('csvForm').reset();
      document.getElementById('clienteSelect').value = '';
      document.getElementById('estrategiaSelect').innerHTML = '<option value="">Primero selecciona un cliente</option>';
      document.getElementById('fechaInicio').value = '';
      document.getElementById('fechaFin').value = '';
      document.getElementById('descripcionMetricas').value = '';
      
      // Limpiar selecciones
      document.querySelectorAll('.etapa-selector').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('.metrica-tag').forEach(el => el.classList.remove('selected'));
      
      // Ocultar elementos
      document.getElementById('infoEstrategia').style.display = 'none';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('csvPreview').style.display = 'none';
      document.getElementById('btnSubir').style.display = 'none';
      
      // Mostrar solo paso 1
      for (let i = 2; i <= 5; i++) {
        document.getElementById(`paso${i}`).style.display = 'none';
        document.getElementById(`step${i}`).classList.remove('active', 'completed');
      }
      document.getElementById('paso1').style.display = 'block';
      document.getElementById('step1').className = 'step active';
      
      // Deshabilitar botones
      ['btnPaso1', 'btnPaso2', 'btnPaso3', 'btnPaso4'].forEach(btn => {
        document.getElementById(btn).disabled = true;
      });
      
      document.getElementById('mensajeInicial').style.display = 'block';
      
      cerrarPopup();
    }

    function irAVerMetricas() {
      const clienteId = document.getElementById('cliente_id').value;
      const estrategiaId = document.getElementById('estrategia_id').value;
      
      if (clienteId && estrategiaId) {
        // Simular redirección
        alert(`Redirigiendo a ver métricas para cliente ${clienteId} y estrategia ${estrategiaId}`);
      } else {
        alert('Redirigiendo a la página de métricas general');
      }
    }

    // Cerrar popup con eventos
    document.getElementById('popupOverlay').addEventListener('click', function(e) {
      if (e.target === this) cerrarPopup();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') cerrarPopup();
    });

    // Simular URL con parámetros de éxito para demostración
    // Descomenta la siguiente línea para ver el popup de éxito inmediatamente:
    // window.history.replaceState({}, document.title, window.location.pathname + '?exito=1&archivo=metricas_test.csv&cliente_id=1&estrategia_id=101&etapa=TOFU&tipo=Ecommerce');
  </script>
</body>
</html>